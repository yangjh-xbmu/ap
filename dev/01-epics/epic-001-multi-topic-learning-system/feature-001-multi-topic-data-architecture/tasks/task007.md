# ⚡ Task-007: ConceptMap 多主题数据结构重构

## 📋 基本信息

- **Task ID**: task-007-conceptmap-multi-topic-refactor
- **所属 Feature**: [Feature-001: 多主题数据架构](../feature-001-multi-topic-data-architecture.md)
- **所属 Epic**: [Epic-001: 多主题学习系统](../../epic-001-multi-topic-learning-system.md)
- **状态**: 待开始
- **优先级**: 高
- **负责人**: 开发者
- **审查人**: 架构师
- **创建日期**: 2024-01-16
- **预计工时**: 3天
- **实际工时**: [完成后填写]
- **截止日期**: 2024-01-19

## 🎯 任务描述

### 任务目标

升级 ConceptMap 类以支持多主题数据结构，实现从单主题到多主题架构的核心数据层重构，为整个学习系统提供多主题数据管理能力。

### 背景说明

当前的 ConceptMap 类只支持单一主题的概念管理，无法满足用户同时学习多个主题（如 Python、JavaScript、React 等）的需求。为了实现多主题学习系统，需要重构数据层以支持多主题数据结构，同时保持向后兼容性。

### 预期产出

- 重构后的 ConceptMap 类，支持多主题数据结构
- 数据迁移功能，自动将旧格式转换为新格式
- 完整的多主题数据操作接口
- 单元测试覆盖所有新功能
- 技术文档更新

## 🔧 技术实现

### 技术方案

#### 实现思路

采用渐进式重构策略，在保持现有接口兼容性的基础上，扩展数据结构以支持多主题。通过版本检测和自动迁移机制，确保现有用户数据的平滑升级。

#### 技术选型

- **编程语言**: Python 3.10+
- **框架/库**: 使用标准库（json、datetime、pathlib）
- **工具**: 无新增工具依赖
- **第三方服务**: 无

#### 架构设计

```
ConceptMap 类架构：
├── 数据层 (Data Layer)
│   ├── 多主题 JSON 结构
│   ├── 版本检测机制
│   └── 自动迁移功能
├── 接口层 (Interface Layer)
│   ├── 主题管理接口
│   ├── 概念操作接口
│   └── 状态更新接口
└── 兼容层 (Compatibility Layer)
    ├── 旧接口适配
    └── 错误处理
```

### 实现细节

#### 核心逻辑

**数据迁移逻辑**：

1. 检测现有数据格式版本（通过 metadata.version 字段）
2. 如果是旧格式，自动将概念数据迁移到 "default" 主题下
3. 添加元数据信息（版本号、时间戳、活跃主题列表）
4. 保持数据完整性和一致性

**主题管理逻辑**：

- 支持动态添加、查询、列出主题
- 维护活跃主题列表
- 自动更新时间戳

**概念操作逻辑**：

- 所有概念操作都需要指定主题路径
- 支持跨主题的概念管理
- 保持原有的状态和掌握度跟踪

#### 数据结构

```json
{
  "topics": {
    "python": {
      "name": "Python Programming",
      "created_at": "2024-01-15T10:30:00Z",
      "concepts": {
        "python-core-syntax": {
          "name": "Python Core Syntax",
          "children": ["variables-and-data-types", "control-flow"],
          "status": {
            "explained": false,
            "quiz_generated": false
          },
          "mastery": {
            "best_score_percent": -1
          }
        }
      }
    }
  },
  "metadata": {
    "version": "2.0",
    "last_updated": "2024-01-16T14:20:00Z",
    "active_topics": ["python"]
  }
}
```

#### API 设计

**新增主题管理方法**：

- `add_topic(topic_id: str, topic_name: str) -> None`
- `get_topic(topic_id: str) -> dict`
- `list_topics() -> List[str]`
- `topic_exists(topic_id: str) -> bool`

**重构概念操作方法**：

- `add_concept(topic_id: str, concept_id: str, concept_data: dict) -> None`
- `update_status(topic_id: str, concept_id: str, status_key: str, value: bool) -> None`
- `update_mastery(topic_id: str, concept_id: str, score_percent: float) -> None`

#### 数据库变更

- **文件结构变更**: concept_map.json 格式升级到 v2.0
- **数据迁移**: 自动将 v1.0 格式迁移到 v2.0
- **向后兼容**: 保持旧接口可用性

### 代码结构

```
ap/
├── core/
│   ├── concept_map.py          # 重构后的 ConceptMap 类
│   └── data_migration.py       # 数据迁移工具
├── tests/
│   ├── test_concept_map.py     # ConceptMap 单元测试
│   └── test_data_migration.py  # 数据迁移测试
└── docs/
    └── multi_topic_api.md      # API 文档
```

## 🔗 依赖关系

### 前置依赖

#### 技术依赖

- [ ] Python 3.10+ 环境
- [ ] 现有 ConceptMap 类的完整理解
- [ ] JSON 数据处理能力

#### 任务依赖

- [ ] **Task-001**: 项目基础架构搭建 - 提供基础代码结构
- [ ] **Task-002**: 需求分析完成 - 明确多主题数据结构需求

#### 资源依赖

- [ ] 开发环境配置完成
- [ ] 测试数据准备（包含旧格式和新格式样例）
- [ ] 代码审查环境

### 后续影响

- **影响的 Task**: Task-008（CLI 命令重构）、Task-009（文件路径管理）
- **影响的组件**: 所有依赖 ConceptMap 的模块
- **影响的用户**: 现有用户需要进行数据迁移

## ✅ 验收条件

### 功能验收

- [ ] ConceptMap 类支持多主题数据结构的加载和保存
- [ ] 自动检测并迁移旧格式的 concept_map.json 文件
- [ ] 新增的主题管理方法（add_topic、get_topic、list_topics）正常工作
- [ ] 重构后的概念操作方法支持主题路径参数
- [ ] 元数据（版本号、时间戳、活跃主题）正确维护

### 代码质量验收

- [ ] 代码符合 PEP 8 编码规范
- [ ] 所有方法都有完整的类型提示
- [ ] 代码注释完整且准确，包含使用示例
- [ ] 代码通过静态分析检查（mypy、flake8）
- [ ] 代码通过同行评审

### 测试验收

- [ ] 单元测试覆盖率达到 95%
- [ ] 所有测试用例通过（包括正常、边界、异常情况）
- [ ] 数据迁移测试通过（多种旧格式数据）
- [ ] 性能测试满足要求（大量主题和概念的处理）

### 文档验收

- [ ] API 文档更新完成，包含所有新方法的说明
- [ ] 数据迁移指南编写完成
- [ ] 代码示例和使用指南更新

### 部署验收

- [ ] 在开发环境测试通过
- [ ] 数据迁移脚本测试通过
- [ ] 向后兼容性验证通过

## 🧪 测试计划

### 单元测试

#### 测试用例

- **测试场景1**: 新格式数据加载和保存
  - 输入: 符合 v2.0 格式的 JSON 数据
  - 预期输出: 正确加载所有主题和概念信息
- **测试场景2**: 旧格式数据自动迁移
  - 输入: v1.0 格式的 concept_map.json
  - 预期输出: 自动迁移到 v2.0 格式，数据完整性保持
- **测试场景3**: 主题管理操作
  - 输入: 添加、查询、列出主题的操作
  - 预期输出: 主题信息正确管理，元数据正确更新
- **测试场景4**: 异常情况处理
  - 输入: 不存在的主题ID、格式错误的数据
  - 预期输出: 抛出明确的错误信息

### 集成测试

- [ ] 与现有 CLI 命令的集成测试
- [ ] 与文件系统操作的集成测试
- [ ] 多用户场景下的数据一致性测试

### 性能测试

- [ ] 大量主题加载测试: 支持100+主题
- [ ] 大量概念处理测试: 每个主题1000+概念
- [ ] 数据迁移性能测试: < 5秒完成迁移

## 🚨 风险评估

### 技术风险

- **风险等级**: 中
- **风险描述**: 数据迁移过程中可能出现数据丢失或格式错误
- **缓解措施**:
  - 实施数据备份机制
  - 详细的迁移前验证
  - 分步骤迁移和回滚机制

### 时间风险

- **风险等级**: 低
- **风险描述**: 复杂的数据结构重构可能超出预期时间
- **缓解措施**:
  - 采用渐进式重构策略
  - 优先实现核心功能
  - 预留缓冲时间

### 依赖风险

- **风险等级**: 低
- **风险描述**: 现有代码对 ConceptMap 的依赖可能导致兼容性问题
- **缓解措施**:
  - 保持旧接口的向后兼容性
  - 提供适配层
  - 充分的集成测试

## 📊 进度跟踪

### 当前状态

- **完成度**: 0%
- **当前阶段**: 设计
- **剩余工时**: 3天
- **预计完成时间**: 2024-01-19

### 工作日志

| 日期 | 工作内容 | 耗时 | 进度 | 备注 |
|------|----------|------|------|------|
| 2024-01-16 | 需求分析和设计 | 4小时 | 20% | 完成技术方案设计 |

### 阻塞问题

| 问题描述 | 影响程度 | 负责人 | 预计解决时间 | 状态 |
|----------|----------|--------|--------------|------|
| 暂无 | - | - | - | - |

## 🔄 变更记录

| 日期 | 版本 | 变更类型 | 变更内容 | 变更原因 | 影响评估 |
|------|------|----------|----------|----------|----------|
| 2024-01-16 | v1.0 | 需求 | 初始任务创建 | 多主题系统需求 | 核心数据层重构 |

## 📝 备注

### 注意事项

- 数据迁移过程中必须保证数据完整性，建议在迁移前自动创建备份
- 新的数据结构设计要考虑未来的扩展性，预留足够的灵活性
- 所有新增的方法都要提供详细的文档字符串和使用示例

### 已知问题

- 当前版本不支持主题间的概念关联，这个功能将在后续版本中实现
- 大量主题和概念的性能优化需要在实际使用中进一步调优

### 后续优化

- 考虑实现主题模板功能，快速创建相似结构的主题
- 添加主题导入导出功能，支持主题间的数据共享
- 实现概念依赖关系的可视化展示

---

**实现指南**：

1. 首先实现数据结构的定义和基础的读写功能
2. 然后实现数据迁移逻辑，确保向后兼容性
3. 逐步添加新的主题管理方法
4. 重构现有的概念操作方法以支持多主题
5. 完善错误处理和异常情况的处理
6. 编写全面的单元测试和集成测试
7. 更新相关文档和使用指南
