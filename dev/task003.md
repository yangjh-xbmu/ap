### **高效开发任务模板 (Task Template)**

#### 🎯 **1. 任务目标 (Task Goal)**

*（用一句话清晰描述本次任务要达成的最终业务目标）*
> 实现 `ap q <concept>` 命令，用于启动基于已生成测验文件的交互式问答环节，并保存测验结果。

#### 📝 **2. 前置条件 (Prerequisites)**

*（执行此任务前必须满足的条件）*

- [ ] 虚拟环境已激活。
- [ ] `requirements.txt` 中的所有依赖已安装。
- [ ] `ap --help` 命令可正常执行。
- [ ] `ap e <concept>` 和 `ap g <concept>` 命令已实现并可正常工作。
- [ ] 存在至少一个测验文件（如通过 `ap g "测试概念"` 生成）。

#### 💻 **3. 技术规格 (Technical Specifications)**

- **命令接口 (Command Interface):**
  - **命令**: `q`, `quiz`
  - **参数**: `concept` (字符串, 必需)
  - **示例**: `ap q "Python装饰器"`

- **文件结构 (File Structure):**
  - **读取**: `workspace/quizzes/<concept-slug>.yml`
  - **写入**: `workspace/results/<concept-slug>_<timestamp>.json`
  - *(注: `<concept-slug>` 是 `concept` 参数经过规范化处理后的文件名，`<timestamp>` 格式为 `YYYYMMDDHHMMSS`)*

- **核心逻辑 (Core Logic):**
    1. 在 `main.py` 中，完善现有的 `quiz` 函数，使用 `@app.command("q")` 装饰器。
    2. 函数接收 `concept: str` 参数。
    3. **路径处理:**
        - 使用现有的 `slugify` 函数将 `concept` 字符串规范化为 `concept-slug`。
        - 构造输入文件路径：`workspace/quizzes/<concept-slug>.yml`。
    4. **前置检查:**
        - 检查 `<concept-slug>.yml` 文件是否存在。
        - 如果文件不存在，使用 `typer.secho` 打印清晰的错误信息（例如：`❌ 错误: 未找到 '概念名' 的测验文件。请先运行 'ap g "概念名"'。`），并以非零状态码退出 (`raise typer.Exit(code=1)`)。
    5. **YAML 解析:**
        - 使用 `PyYAML` 库读取并解析 YAML 文件内容。
        - 验证文件格式是否正确（包含问题列表，每个问题都有 `question`, `options`, `answer` 三个键）。
    6. **交互式问答:**
        - 遍历问题列表，对于每个问题：
            - 打印问题标题（如 `问题 1/5: <question>`）。
            - 用数字（1, 2, 3, 4）列出所有选项。
            - 获取用户输入的数字（1-4）。
            - 验证输入有效性，如果无效则重新提示。
            - 判断答案是否正确，并立即给出反馈（✅ 正确！/ ❌ 错误，正确答案是：...）。
            - 记录用户的选择和正确性。
    7. **结果统计:**
        - 计算总分和正确率。
        - 显示最终结果（例如：`🎉 测验完成！你答对了 3/5 题，正确率 60%`）。
    8. **结果保存:**
        - 创建包含详细结果的 JSON 对象，包括：
            - 概念名称、测验时间、总题数、正确题数、正确率
            - 每题的详细信息（问题、用户答案、正确答案、是否正确）
        - 生成带时间戳的文件名：`<concept-slug>_YYYYMMDDHHMMSS.json`
        - 确保 `workspace/results/` 目录存在，并保存结果文件。
        - 打印保存成功的消息。

- **依赖变更 (Dependencies):**
  - 无新增依赖（`PyYAML` 和 `json` 已在项目中）。

#### ✅ **4. 验收标准 (Acceptance Criteria)**

*（一个可执行的、用于验证任务是否完成的清单）*

- [ ] **命令注册成功**：运行 `ap --help`，输出中应包含 `q` 命令及其描述。
- [ ] **错误处理正确**：运行 `ap q "不存在的概念"`，终端应打印明确的错误提示并退出。
- [ ] **YAML 解析成功**：能够正确读取和解析现有的测验文件格式。
- [ ] **交互功能完整**：
  - [ ] 能够逐题显示问题和选项。
  - [ ] 能够接收用户输入并验证有效性。
  - [ ] 能够判断答案正确性并给出即时反馈。
  - [ ] 能够处理无效输入（非1-4的数字）并重新提示。
- [ ] **结果统计准确**：能够正确计算总分和正确率。
- [ ] **文件保存成功**：
  - [ ] `workspace/results/` 目录被创建。
  - [ ] 生成带时间戳的 JSON 结果文件。
  - [ ] JSON 文件包含完整的测验结果信息。
  - [ ] JSON 格式合法且可读。
- [ ] **完整流程测试**：能够完成从 `ap e` -> `ap g` -> `ap q` 的完整工作流。

#### ❓ **5. 潜在风险 (Potential Risks)**

*（预判可能遇到的问题）*
>
> - YAML 文件可能格式不正确或缺少必要的键，需要做适当的错误处理和验证。
> - 用户可能输入无效的选项（非1-4的数字或非数字字符），需要输入验证和重试机制。
> - 在某些系统上，中文字符的显示可能存在编码问题，需要确保正确的 UTF-8 编码处理。
> - 时间戳生成需要考虑时区问题，建议使用本地时间。
> - JSON 文件保存时可能遇到权限问题或磁盘空间不足的情况。
