# 🚀 项目启动简报：命令行学习工具 `ap`

请仔细阅读以下项目蓝图，它包含了我们的目标、技术栈和关键实现细节。

## 1. 🎯 核心目标 (Overall Goal)

`ap` 是一个帮助用户通过结构化学习路径来掌握新概念的智能学习工具。它采用"地图-解释-测验-追踪"的完整学习循环，提供系统性的知识获取体验。

### 核心工作流包含五个命令

#### 📍 学习规划命令

1. **`ap m <topic>` (Map):** 用户输入宏观主题（如"Python Core Syntax"），AI将其拆解为结构化学习路径，生成包含所有子概念的学习地图。
2. **`ap t` (Status/Tree):** 学习仪表盘功能，以树状结构展示完整学习地图，包含每个知识点的完成状态和掌握程度。

#### 🎓 学习执行命令  

3. **`ap e <concept>` (Explain):** 用户提供一个概念名称，工具调用 LLM API 生成该概念的详细 Markdown 解释，并保存到本地文件。执行后自动更新学习地图状态。
4. **`ap g <concept>` (Generate):** 工具读取之前生成的 Markdown 解释，再次调用 LLM API，要求其根据文本内容生成一份 YAML 格式的选择题测验卷，并保存。执行后自动更新学习地图状态。
5. **`ap q <concept>` (Quiz):** 工具读取 YAML 格式的测验卷，在命令行中启动一个交互式问答环节，最后统计用户的得分并保存结果。测验完成后自动更新学习地图中的掌握程度。

我们的目标是创建一个流畅、自动化、结构化且对用户友好的完整学习体验。

## 2. 🛠️ 技术选型 (Tech Stack)

请严格遵守以下技术选型，不要使用其他替代方案：

* **语言:** Python 3.10+
* **命令行框架:** **Typer**。因为它利用类型提示，代码简洁且对 IDE 友好。
* **LLM 交互:** **`deepseek`** 官方 Python 库。
* **API 密钥管理:** **`python-dotenv`** 库，用于从 `.env` 文件中安全加载 `DEEPSEEK_API_KEY`。**绝不能硬编码密钥。**
* **数据格式处理:**
  * **YAML:** 使用 **`PyYAML`** 库进行读写。
  * **JSON:** 使用 Python 内置的 **`json`** 模块。
  * **Markdown:** 使用标准的 Python 文件 I/O (`pathlib` 模块)。
* **依赖管理:** 使用 `pip` 和一个 `requirements.txt` 文件。

## 3. 📁 项目结构 (Project Structure)

请按以下结构组织项目文件。所有生成的内容都应存放在一个主工作目录 (`workspace`) 下，并按类型分子目录，以保持整洁。

```
ap_cli/
├── .gitignore          # 忽略 .env, pycache, .venv, workspace/ 等
├── .env                # 存储 API 密钥, 例如: DEEPSEEK_API_KEY="sk-..."
├── main.py             # 项目主入口，包含所有 Typer 命令
├── requirements.txt    # 项目依赖
└── workspace/          # 存放所有生成内容的主目录
    ├── concept_map.json    # 核心学习地图文件，存储所有概念的结构化关系和状态
    ├── explanation/        # 存放解释文档
    │   ├── python-core-syntax.md
    │   ├── variables-and-data-types.md
    │   └── control-flow.md
    ├── quizzes/           # 存放测验文件
    │   ├── python-core-syntax.yml
    │   ├── variables-and-data-types.yml
    │   └── control-flow.yml
    └── results/           # 存放测验结果
        ├── variables-and-data-types_20231027153000.json
        └── control-flow_20231028094500.json
```

## 4. 🗺️ 核心数据结构：concept_map.json (Core Data Structure)

`concept_map.json` 是整个学习系统的核心，它存储了所有概念的结构化关系、学习状态和掌握程度。这个文件位于 `workspace/concept_map.json`，采用JSON格式便于程序读写和用户查看。

### 数据结构设计

```json
{
  "python-core-syntax": {
    "name": "Python Core Syntax",
    "children": [
      "variables-and-data-types",
      "control-flow", 
      "functions-and-scope",
      "data-structures"
    ],
    "status": {
      "explained": false,
      "quiz_generated": false
    },
    "mastery": {
      "best_score_percent": -1
    }
  },
  "variables-and-data-types": {
    "name": "Variables and Data Types",
    "children": [],
    "status": {
      "explained": true,
      "quiz_generated": true
    },
    "mastery": {
      "best_score_percent": 80.0
    }
  },
  "control-flow": {
    "name": "Control Flow",
    "children": [],
    "status": {
      "explained": true,
      "quiz_generated": false
    },
    "mastery": {
      "best_score_percent": -1
    }
  }
}
```

### 字段说明

* **概念ID (Key):** 使用slugify后的概念名称作为唯一标识符
* **name:** 概念的原始显示名称
* **children:** 子概念ID列表，支持层级结构
* **status.explained:** 是否已生成解释文档
* **status.quiz_generated:** 是否已生成测验题目
* **mastery.best_score_percent:** 最高测验得分百分比，-1表示未参加测验

### 状态更新规则

1. **`ap m <topic>`:** 创建主题及其子概念的完整结构
2. **`ap e <concept>`:** 将对应概念的 `explained` 设为 `true`
3. **`ap g <concept>`:** 将对应概念的 `quiz_generated` 设为 `true`
4. **`ap q <concept>`:** 更新 `best_score_percent`（仅当新分数更高时）

## 5. 🧠 关键逻辑与 Prompt 设计 (Key Logic & Prompts)

这是项目成功的关键，请特别注意：

* **文件名规范化 (Slugify):** 用户输入的概念（如 "SOLID Principles"）需要被转换成对文件系统友好的名称（如 `solid-principles`）用于创建目录。一个简单的规则是：转为小写，用连字符 `-` 替换空格和特殊字符。
* **错误处理:** 程序需要处理常见错误。例如，如果用户直接运行 `ap g <concept>` 而对应的 `explanation.md` 文件不存在，应提示用户先运行 `ap e <concept>`。
* **Prompt for `ap e`:** 生成解释的 Prompt 必须要求 LLM 输出结构化的 Markdown，应包含以下部分：
  * `# [Concept Name]`
  * `## 📖 定义`
  * `## 🎯 核心原理`
  * `## 💡 实际应用`
  * `## ✅ 优点`
  * `## ❌ 缺点/限制`
  * `## 🔗 相关概念`
  * `## 📚 学习建议`
  
  **增强功能：** 执行完成后，自动更新 `concept_map.json` 中对应概念的 `status.explained` 为 `true`。
* **Prompt for `ap g`:** 生成测验的 Prompt 必须提供清晰的输出格式指令，并包含一个示例以确保输出的稳定性。
    > "Based on the following text, please generate 5 multiple-choice questions in YAML format.
    > Each question must include a 'question' key, an 'options' key (which is a list of 4 strings), and an 'answer' key (which is the exact text of the correct option).
    >
    > Strictly adhere to the YAML format provided in the example below. Do not include any extra introductory text, explanations, or code block markers (like ```yaml).
    >
    > ---
    > EXAMPLE:
    > * question: "What is the 'S' in SOLID?"
    >   options:
    >   * "Single Responsibility Principle"
    >   * "Software Lifecycle"
    >   * "System Design"
    >   * "Simple Object"
    >   answer: "Single Responsibility Principle"
    > ---
    >
    > Here is the text to base the questions on:
    >
    > {markdown_content}
    > "

    **增强功能：** 执行完成后，自动更新 `concept_map.json` 中对应概念的 `status.quiz_generated` 为 `true`。

* **`ap q` 交互逻辑:**
    1. 读取并解析 `workspace/quizzes/<concept>.yml` 文件。
    2. 遍历问题列表。
    3. 对于每个问题：打印问题，并用数字（1, 2, 3, 4）列出选项。
    4. 获取用户输入的数字。
    5. 判断答案是否正确，并立即给出反馈。
    6. 循环结束后，计算并显示总分（例如 "你答对了 3/5 题，正确率 60%"）。
    7. 将本次测验的详细结果（包括每题的回答、是否正确、最终得分等）保存为一个带时间戳的 JSON 文件到 `workspace/results/` 目录下。

    **增强功能：** 执行完成后，自动更新 `concept_map.json` 中对应概念的 `mastery.best_score_percent`（仅当新分数更高时）。
