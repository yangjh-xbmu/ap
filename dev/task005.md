### **高效开发任务模板 (Task Template) - Task005**

#### 🎯 **1. 任务目标 (Task Goal)**

*（用一句话清晰描述本次任务要达成的最终业务目标）*
> 改进测试题生成功能，支持基于文档知识点结构的智能题目数量分配和用户自定义题目数量配置，确保每个子知识点都能被充分测试覆盖。

#### 📝 **2. 前置条件 (Prerequisites)**

*（执行此任务前必须满足的条件）*

- [ ] 虚拟环境已激活。
- [ ] `requirements.txt` 中的所有依赖已安装。
- [ ] `ap --help` 命令可正常执行。
- [ ] `ap e`、`ap g`、`ap q` 命令均已实现并正常工作。
- [ ] 已完成对当前测试题生成逻辑的分析。

#### 🔍 **3. 问题分析 (Problem Analysis)**

**当前问题：**
1. **硬编码题目数量**：在 `create_quiz_prompt` 函数中硬编码生成 5 道选择题
2. **知识点覆盖不均**：无论文档内容多少，都只生成固定 5 题，可能导致：
   - 复杂概念（如Python装饰器有6个主要知识点）覆盖不全
   - 简单概念过度测试
3. **缺乏配置灵活性**：用户无法根据学习需求调整题目数量

**知识点分析结果：**
以"Python装饰器"为例，文档包含以下知识点：
- 简明定义 (Core Definition)
- 核心思想/原理 (Core Principles) - 包含3个子点
- 举例说明 (Example)
- 优点 (Pros) - 包含4个子点
- 缺点 (Cons) - 包含3个子点
- 类比 (Analogy)

**总计：6个主要知识点，10个子知识点**，但当前只生成5道题，覆盖不充分。

#### 💻 **4. 技术规格 (Technical Specifications)**

- **命令接口改进 (Enhanced Command Interface):**
  - **命令**: `g`, `generate_quiz`
  - **新增参数**: 
    - `--num-questions` / `-n`: 指定题目数量 (可选，默认为智能计算)
    - `--mode`: 生成模式 (`auto`/`fixed`) (可选，默认为`auto`)
  - **示例**: 
    - `ap g "Python装饰器"` (智能模式，根据知识点自动计算)
    - `ap g "Python装饰器" -n 8` (固定8题)
    - `ap g "Python装饰器" --mode fixed -n 5` (固定5题，兼容旧版本)

- **智能题目数量计算规则:**
  1. **解析文档结构**：识别主要章节（## 标题）
  2. **计算基础题目数**：主要章节数 × 1.5，向上取整
  3. **调整规则**：
     - 最少 3 题（简单概念）
     - 最多 12 题（复杂概念）
     - 有代码示例的概念 +1 题
     - 有类比说明的概念 +1 题

- **核心逻辑改进 (Enhanced Core Logic):**
    1. **修改 `create_quiz_prompt` 函数**：
        - 添加 `num_questions` 参数
        - 动态构建题目数量要求
        - 增强知识点覆盖指导
    
    2. **新增 `analyze_document_structure` 函数**：
        - 解析Markdown文档结构
        - 识别主要知识点和子知识点
        - 计算建议题目数量
    
    3. **修改 `generate_quiz` 命令函数**：
        - 添加新的命令行参数
        - 实现智能/固定模式切换
        - 集成文档结构分析
    
    4. **增强Prompt策略**：
        - 明确要求每个主要知识点至少1题
        - 指导AI平衡分配题目到各知识点
        - 保持现有题目质量标准

#### 🛠️ **5. 实现步骤 (Implementation Steps)**

1. **步骤1**: 新增文档结构分析功能
   - 实现 `analyze_document_structure()` 函数
   - 解析Markdown标题层级
   - 计算智能题目数量

2. **步骤2**: 改进Prompt构建逻辑
   - 修改 `create_quiz_prompt()` 函数
   - 支持动态题目数量
   - 增强知识点覆盖指导

3. **步骤3**: 升级命令行接口
   - 为 `generate_quiz()` 添加新参数
   - 实现智能/固定模式
   - 保持向后兼容性

4. **步骤4**: 测试和验证
   - 测试不同复杂度的概念
   - 验证知识点覆盖效果
   - 确保题目质量不下降

#### ✅ **6. 验收标准 (Acceptance Criteria)**

- [ ] 智能模式能根据文档复杂度自动调整题目数量
- [ ] 固定模式支持用户自定义题目数量（3-12题范围）
- [ ] 生成的题目能覆盖文档中的主要知识点
- [ ] 保持现有题目质量标准（4选项、准确答案、适中难度）
- [ ] 向后兼容：`ap g <concept>` 仍能正常工作
- [ ] 新功能：`ap g <concept> -n 8` 能生成指定数量题目
- [ ] 复杂概念（6+知识点）生成7-10题
- [ ] 简单概念（2-3知识点）生成3-5题

#### 🧪 **7. 测试用例 (Test Cases)**

1. **智能模式测试**：
   - 复杂概念："Python装饰器" → 应生成7-9题
   - 简单概念："变量定义" → 应生成3-4题

2. **固定模式测试**：
   - `ap g "Python装饰器" -n 8` → 精确生成8题
   - `ap g "Python装饰器" --mode fixed -n 5` → 精确生成5题

3. **边界测试**：
   - 最小值：`-n 3` → 生成3题
   - 最大值：`-n 12` → 生成12题
   - 超出范围：`-n 15` → 自动调整为12题并提示

4. **兼容性测试**：
   - `ap g "概念名"` → 使用智能模式，正常工作
   - 生成的YAML格式保持不变
   - 现有的 `ap q` 命令能正常读取新生成的题目