# 🚀 基于ai的命令行学习工具 `ap`

请仔细阅读以下项目蓝图，它包含了我们的目标、技术栈和关键实现细节。

## 1. 🎯 核心目标 (Overall Goal)

`ap` 是一个帮助用户通过结构化学习路径来掌握新概念的智能学习工具。它采用"地图-解释-测验-追踪"的完整学习循环，提供系统性的知识获取体验。

### 核心工作流包含五个命令

#### 📍 学习规划命令

1. **`ap m <topic>` (Map):** 用户输入宏观主题（如"Python Programming"），AI将其拆解为结构化学习路径，生成包含所有子概念的学习地图。在多主题环境下，每个主题都有独立的概念树结构。
2. **`ap t [topic]` (Status/Tree):** 学习仪表盘功能，以树状结构展示学习地图。如果指定主题，则只显示该主题的学习进度；如果不指定，则显示所有主题的概览，包含每个知识点的完成状态和掌握程度。

#### 🎓 学习执行命令  

1. **`ap e <topic>/<concept>` (Explain):** 用户提供主题和概念名称（格式：`主题/概念`），工具调用 LLM API 生成该概念的详细 Markdown 解释，并保存到 `workspace/<topic>/explanation/<concept>.md`。执行后自动更新学习地图状态。
2. **`ap g <topic>/<concept>` (Generate):** 工具读取之前生成的 Markdown 解释，再次调用 LLM API，要求其根据文本内容生成一份 YAML 格式的选择题测验卷，并保存到 `workspace/<topic>/quizzes/<concept>.yml`。执行后自动更新学习地图状态。
3. **`ap q <topic>/<concept>` (Quiz):** 工具读取 YAML 格式的测验卷，在命令行中启动一个交互式问答环节，最后统计用户的得分并保存结果到 `workspace/<topic>/results/<concept>_<timestamp>.json`。测验完成后自动更新学习地图中的掌握程度。

我们的目标是创建一个流畅、自动化、结构化且对用户友好的完整学习体验。

## 2. 🛠️ 技术选型 (Tech Stack)

请严格遵守以下技术选型，不要使用其他替代方案：

* **语言:** Python 3.10+
* **命令行框架:** **Typer**。因为它利用类型提示，代码简洁且对 IDE 友好。
* **LLM 交互:** **`openai`** 库，通过配置 `base_url` 连接到 DeepSeek API。
* **API 密钥管理:** **`python-dotenv`** 库，用于从 `.env` 文件中安全加载 `DEEPSEEK_API_KEY`。**绝不能硬编码密钥。**
* **数据格式处理:**
  * **YAML:** 使用 **`PyYAML`** 库进行读写。
  * **JSON:** 使用 Python 内置的 **`json`** 模块。
  * **Markdown:** 使用标准的 Python 文件 I/O (`pathlib` 模块)。
* **依赖管理:** 使用 `pip` 和一个 `requirements.txt` 文件。

## 3. 📁 项目结构 (Project Structure)

请按以下结构组织项目文件。所有生成的内容都应存放在一个主工作目录 (`workspace`) 下，并按类型分子目录，以保持整洁。

```
ap/
├── .gitignore          # 忽略 .env, pycache, .venv, workspace/ 等
├── .env                # 存储 API 密钥, 例如: DEEPSEEK_API_KEY="sk-..."
├── .env.example        # API 密钥配置示例文件
├── ap/                 # 主要代码目录
│   ├── __init__.py
│   ├── cli.py          # 项目主入口，包含所有 Typer 命令
│   ├── cli_commands/   # CLI 命令实现模块
│   │   ├── __init__.py
│   │   ├── explain.py
│   │   ├── generate_quiz.py
│   │   ├── quiz.py
│   │   ├── generate_map.py
│   │   ├── study.py
│   │   └── display_tree.py
│   └── core/           # 核心功能模块
│       ├── __init__.py
│       ├── concept_map.py
│       └── utils.py
├── dev/                # 开发文档和规范
│   ├── 00-specs/       # 项目规范文档
│   └── 01-epics/       # 功能开发文档
├── docs/               # 用户文档
├── tests/              # 测试文件
├── requirements.txt    # 项目依赖
├── setup.py           # 项目安装配置
├── setup_env.py       # 环境设置脚本
└── workspace/          # 存放所有生成内容的主目录
    ├── concept_map.json    # 核心学习地图文件
    └── <topic>/            # 按主题组织的目录
        ├── explanation/    # 存放解释文档
        │   └── <concept>.md
        ├── quizzes/        # 存放测验文件
        │   └── <concept>.yml
        └── results/        # 存放测验结果
            └── <concept>_<timestamp>.json
```

## 4. 🗺️ 核心数据结构：concept_map.json (Core Data Structure)

`concept_map.json` 是整个学习系统的核心，它存储了所有主题和概念的结构化关系、学习状态和掌握程度。这个文件位于 `workspace/concept_map.json`，采用JSON格式便于程序读写和用户查看。

### 多主题数据结构设计

```json
{
  "topics": {
    "python-programming": {
      "name": "Python Programming",
      "created_at": "2024-01-15T10:30:00Z",
      "concepts": {
        "variables-and-data-types": {
          "name": "Variables and Data Types",
          "status": "explained",
          "mastery": {
            "best_score_percent": 80.0
          }
        },
        "control-flow": {
          "name": "Control Flow",
          "status": "quiz_generated",
          "mastery": {
            "best_score_percent": -1
          }
        },
        "functions-and-scope": {
          "name": "Functions and Scope",
          "status": "quiz_taken",
          "mastery": {
            "best_score_percent": 75.0
          }
        }
      }
    },
    "python核心语法": {
      "name": "Python核心语法",
      "created_at": "2024-12-19T08:30:00Z",
      "concepts": {
        "变量和数据类型": {
          "name": "变量和数据类型",
          "status": "explained",
          "mastery": {
            "best_score_percent": -1
          }
        }
      }
    }
  },
  "metadata": {
    "version": "2.0",
    "last_updated": "2024-12-19T08:30:00Z",
    "active_topics": ["python-programming", "python核心语法", "python基础语法"]
  }
}
```

### 字段说明

#### 顶层结构

* **topics:** 包含所有学习主题的容器
* **metadata:** 全局元数据信息
  * **version:** 数据结构版本号
  * **last_updated:** 最后更新时间
  * **active_topics:** 当前活跃的主题列表

#### 主题级别字段

* **主题ID (Key):** 使用slugify后的主题名称作为唯一标识符（如 "python-programming", "python核心语法"）
* **name:** 主题的原始显示名称
* **created_at:** 主题创建时间
* **concepts:** 该主题下所有概念的容器

#### 概念级别字段

* **概念ID (Key):** 使用slugify后的概念名称作为唯一标识符
* **name:** 概念的原始显示名称
* **status:** 概念的学习状态，可能的值：
  * `"not_started"` - 未开始学习
  * `"explained"` - 已生成解释文档
  * `"quiz_generated"` - 已生成测验题目
  * `"quiz_taken"` - 已完成测验
* **mastery.best_score_percent:** 最高测验得分百分比，-1表示未参加测验

### 状态更新规则

1. **`ap m <topic>`:** 创建或更新指定主题及其子概念的完整结构
2. **`ap e <concept>` 或 `ap e <topic>/<concept>`:** 将对应概念的 `status` 设为 `"explained"`
3. **`ap g <concept>` 或 `ap g <topic>/<concept>`:** 将对应概念的 `status` 设为 `"quiz_generated"`
4. **`ap q <concept>` 或 `ap q <topic>/<concept>`:** 将对应概念的 `status` 设为 `"quiz_taken"`，并更新 `best_score_percent`（仅当新分数更高时）

### 文件路径映射规则

在多主题环境下，文件路径遵循以下规则：

* **解释文档:** `workspace/<topic>/explanation/<concept>.md`
* **测验文件:** `workspace/<topic>/quizzes/<concept>.yml`
* **测验结果:** `workspace/<topic>/results/<concept>_<timestamp>.json`

## 5. 🧠 关键逻辑与 Prompt 设计 (Key Logic & Prompts)

这是项目成功的关键，请特别注意：

### 多主题环境下的核心逻辑

* **主题识别:** 所有命令现在需要支持 `<topic>/<concept>` 格式的参数，例如：
  * `ap e python/variables-and-data-types`
  * `ap g javascript/functions-and-closures`
  * `ap q markdown/syntax-basics`

* **文件路径管理:** 根据主题自动创建和管理子目录结构：
  * 解释文档: `workspace/<topic>/explanation/<concept>.md`
  * 测验文件: `workspace/<topic>/quizzes/<concept>.yml`
  * 测验结果: `workspace/<topic>/results/<concept>_<timestamp>.json`

* **文件名规范化 (Slugify):** 用户输入的主题和概念（如 "JavaScript Basics"）需要被转换成对文件系统友好的名称（如 `javascript-basics`）用于创建目录。一个简单的规则是：转为小写，用连字符 `-` 替换空格和特殊字符。

* **错误处理:** 程序需要处理常见错误。例如：
  * 如果用户直接运行 `ap g python/variables` 而对应的解释文档不存在，应提示用户先运行 `ap e python/variables`
  * 如果指定的主题不存在，应提示用户先运行 `ap m <topic>` 创建主题
  * 如果概念路径格式不正确，应提供正确的使用示例

### 命令参数格式更新

* **`ap m <topic>`:** 创建新主题的学习地图
  * 示例: `ap m "Python Programming"`
  * 效果: 在concept_map.json中创建python-programming主题及其子概念

* **`ap e <concept>` 或 `ap e <topic>/<concept>`:** 生成概念的解释
  * 示例: `ap e variables-and-data-types` 或 `ap e python/variables-and-data-types`
  * 效果: 生成 `workspace/<topic>/explanation/<concept>.md`

* **`ap g <concept>` 或 `ap g <topic>/<concept>`:** 生成指定概念的测验
  * 示例: `ap g variables-and-data-types` 或 `ap g python/variables-and-data-types`
  * 效果: 生成 `workspace/<topic>/quizzes/<concept>.yml`

* **`ap q <concept>` 或 `ap q <topic>/<concept>`:** 开始指定概念的测验
  * 示例: `ap q variables-and-data-types` 或 `ap q python/variables-and-data-types`
  * 效果: 读取测验文件并开始交互式问答

* **`ap s <concept>` 或 `ap s <topic>/<concept>`:** 学习指定概念（解释+测验+问答的完整流程）
  * 示例: `ap s variables-and-data-types` 或 `ap s python/variables-and-data-types`
  * 效果: 依次执行解释、生成测验、进行测验的完整学习流程

* **`ap t [topic]`:** 显示学习进度树
  * 示例: `ap t` 或 `ap t python`
  * 效果: 显示所有主题或指定主题的学习进度

### Prompt 设计保持不变

* **Prompt for `ap e`:** 生成解释的 Prompt 必须要求 LLM 输出结构化的 Markdown，应包含以下部分：
  * `# [Concept Name]`
  * `## 📖 定义`
  * `## 🎯 核心原理`
  * `## 💡 实际应用`
  * `## ✅ 优点`
  * `## ❌ 缺点/限制`
  * `## 🔗 相关概念`
  * `## 📚 学习建议`
  
  **增强功能：** 执行完成后，自动更新 `concept_map.json` 中对应主题下概念的 `status` 为 `"explained"`。

* **Prompt for `ap g`:** 生成测验的 Prompt 必须提供清晰的输出格式指令，并包含一个示例以确保输出的稳定性。
    > "Based on the following text, please generate 5 multiple-choice questions in YAML format.
    > Each question must include a 'question' key, an 'options' key (which is a list of 4 strings), and an 'answer' key (which is the exact text of the correct option).
    >
    > Strictly adhere to the YAML format provided in the example below. Do not include any extra introductory text, explanations, or code block markers (like ```yaml).
    >
    > ---
    > EXAMPLE:
    > * question: "What is the 'S' in SOLID?"
    >   options:
    >   * "Single Responsibility Principle"
    >   * "Software Lifecycle"
    >   * "System Design"
    >   * "Simple Object"
    >   answer: "Single Responsibility Principle"
    > ---
    >
    > Here is the text to base the questions on:
    >
    > {markdown_content}
    > "

    **增强功能：** 执行完成后，自动更新 `concept_map.json` 中对应主题下概念的 `status` 为 `"quiz_generated"`。

* **`ap q` 交互逻辑:**
    1. 读取并解析 `workspace/quizzes/<topic>/<concept>.yml` 文件。
    2. 遍历问题列表。
    3. 对于每个问题：打印问题，并用数字（1, 2, 3, 4）列出选项。
    4. 获取用户输入的数字。
    5. 判断答案是否正确，并立即给出反馈。
    6. 循环结束后，计算并显示总分（例如 "你答对了 3/5 题，正确率 60%"）。
    7. 将本次测验的详细结果（包括每题的回答、是否正确、最终得分等）保存为一个带时间戳的 JSON 文件到 `workspace/results/<topic>/` 目录下。

    **增强功能：** 执行完成后，自动更新 `concept_map.json` 中对应主题下概念的 `status` 为 `"quiz_taken"`，并更新 `mastery.best_score_percent`（仅当新分数更高时）。

## 6. 📋 多主题学习最佳实践 (Multi-Topic Learning Best Practices)

### 典型使用场景

#### 场景1：开始学习新的编程语言

```bash
# 1. 创建Python学习地图
ap m "Python Programming"

# 2. 查看生成的学习路径
ap t python-programming

# 3. 开始学习第一个概念
ap e variables-and-data-types

# 4. 生成测验并练习
ap g variables-and-data-types
ap q variables-and-data-types
```

#### 场景2：同时学习多个相关主题

```bash
# 创建前端开发相关的多个主题
ap m "JavaScript Fundamentals"
ap m "HTML & CSS Basics"
ap m "React Framework"

# 查看所有主题的概览
ap t

# 按优先级学习不同主题的概念
ap e variables-and-scope
ap e semantic-html
ap e components-and-props
```

#### 场景3：复习和巩固已学内容

```bash
# 查看特定主题的学习进度
ap t python-programming

# 重新测验掌握不够好的概念
ap q functions-and-scope
ap q object-oriented-programming
```

### 主题命名建议

为了保持一致性和可读性，建议遵循以下命名规范：

* **编程语言类：** "Python Programming", "JavaScript Fundamentals", "Go Language Basics"
* **框架工具类：** "React Framework", "Django Web Development", "Docker Containerization"
* **概念理论类：** "Data Structures & Algorithms", "Software Design Patterns", "Database Design Principles"
* **技能实践类：** "Web Development Basics", "API Design & Development", "Testing & Quality Assurance"

### 学习路径规划建议

1. **基础优先：** 先创建基础概念的主题，再逐步扩展到高级主题
2. **相关性分组：** 将相关的技术栈组织在一起学习（如前端三件套：HTML、CSS、JavaScript）
3. **实践导向：** 每个主题都应该包含理论学习和实际应用的概念
4. **循序渐进：** 在一个主题达到一定掌握程度后再开始新主题

### 文件管理技巧

* **定期备份：** `concept_map.json` 包含了所有学习进度，建议定期备份
* **版本控制：** 可以将整个 `workspace` 目录纳入 Git 管理，追踪学习历程
* **清理策略：** 定期清理 `results` 目录中的旧测验记录，保持文件系统整洁
* **导出总结：** 可以基于 `concept_map.json` 生成学习报告和进度统计

### 学习效率优化

1. **设置学习目标：** 为每个主题设定明确的完成时间和掌握标准
2. **交替学习：** 在不同主题间切换学习，避免单一主题的疲劳
3. **定期回顾：** 利用 `ap t` 命令定期查看整体进度，调整学习计划
4. **测验驱动：** 通过反复测验来巩固知识点，提高长期记忆效果
